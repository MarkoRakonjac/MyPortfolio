<!-- /templates/cart.liquid -->
{% comment %}

    For info on test orders:
    - General http://docs.shopify.com/manual/your-store/orders/test-orders
    - Shopify Payments - http://docs.shopify.com/manual/more/shopify-payments/testing-shopify-payments

{% endcomment %}

{% if cart.item_count > 0 %}

    <div class="sitewide--title-wrapper">
        {% if settings.heading_style == 'zigzag' %}<span class="zig-zag-border"></span>{% endif %}
        <h1 class="page--title">{{ 'cart.general.title' | t }}</h1>
    </div>

    {% assign totalPrice =0 %}
    <form action="{{ routes.cart_url }}" method="post" novalidate class="cart table-wrap">
        <table class="cart-table full table--responsive">
            <thead class="cart__row cart__header-labels">
            <th colspan="2" class="text-center"></th>
            <th class="text-center">{{ 'cart.label.price' | t }}</th>
            <th class="text-center">{{ 'cart.label.quantity' | t }}</th>
            <th class="text-center">{{ 'cart.label.total' | t }}</th>
            </thead>
            <tbody>
            {% for item in cart.items %}
                <tr class="cart__row table__section" data-item-title="{{ item.title }}" data-item-collections="{% for collection in item.product.collections %}{{ collection.handle }}{% unless forloop.last %},{% endunless %}{% endfor %}">
                    <td data-label="{{ 'customer.order.product' | t }}">
                        <a href="{{ item.url | within: collections.all }}" class="cart__image">
                            {% comment %}
                                More image size options at:
                                - http://docs.shopify.com/themes/filters/product-img-url
                            {% endcomment %}
                            {% include 'responsive-image' with item, alt: item.title %}
                        </a>
                    </td>
                    <td>
                        <a href="{{ item.url }}" class="h5">
                            {{ item.product.title }}
                        </a>
                        {% unless item.variant.title contains 'Default' %}
                            <div class="cart__meta-text">
                                {% for option in item.product.options %}
                                    {{ option }}: {{ item.variant.options[forloop.index0] }}<br/>
                                {% endfor %}
                            </div>
                        {% endunless %}

                        {% if settings.cart_vendor_enable %}
                            <p>{{ item.vendor }}</p>
                        {% endif %}

                        {% comment %}
                            Optional, loop through custom product line items if available

                            For more info on line item properties, visit:
                            - http://docs.shopify.com/support/your-store/products/how-do-I-collect-additional-information-on-the-product-page-Like-for-a-monogram-engraving-or-customization
                        {% endcomment %}
                        {% assign property_size = item.properties | size %}
                        {% if property_size > 0 %}
                            {% for p in item.properties %}
                                {% if p.first == "Entrega/Delivery" %}
                                    {{ p.first }} {{ p.last }}
                                {% endif  %}
                            {% endfor %}
                        {% endif %}

                        <a href="{{ routes.cart_url }}/change?line={{ forloop.index }}&amp;quantity=0"
                           class="cart__remove">
                            <small>{{ 'cart.general.remove' | t }}</small>
                        </a>
                    </td>
                    <td class="text-center" data-label="{{ 'cart.label.price' | t }}">
                        {%- if item.original_price != item.final_price -%}
                            <span class="hidden">{{ 'products.general.regular_price' | t }}</span>
                            <span class="h5">
                    <del><span class="money">{% include "price-with-rate" | price: item.original_price | iva: item.product.metafields.products["Tax percentage"] %}</span></del>
                  </span>
                            <span class="hidden">{{ 'products.general.sale_price' | t }}</span>
                            <span class="h5">
                  <span class="order-discount discount--sale-color"><span
                              class="money">{% include "price-with-rate" | price: item.final_price | iva: item.product.metafields.products["Tax percentage"] %}</span></span>
                </span>
                        {%- else -%}
                            <span class="h5">
                  <span class="money">{% include "price-with-rate" | price: item.original_price | iva: item.product.metafields.products["Tax percentage"] %}</span>
                </span>
                        {%- endif -%}

                        {% include 'unit-price-measurement-variant', variant: item %}
                        </span>
                    </td>
                    <td class="text-center" data-label="{{ 'cart.label.quantity' | t }}">
                        <input type="number" name="updates[]" id="updates_{{ item.id }}" value="{{ item.quantity }}"
                               min="0">
                    </td>
                    <td class="text-center cart-total-label" data-label="{{ 'cart.label.total' | t }}">
                        {%- if item.original_line_price != item.final_line_price -%}
                            <span class="hidden">{{ 'products.general.regular_price' | t }}</span>
                            <span class="h5">
  						    <del><span class="money">{% include "price-with-rate" | price: item.original_line_price | iva: item.product.metafields.products["Tax percentage"] %}</span></del>
                </span>
                            <span class="hidden">{{ 'products.general.sale_price' | t }}</span>
                            <span class="h5">
  							  <span class="order-discount discount--sale-color"><span
                                          class="money">{% include "price-with-rate" | price: item.final_line_price | iva: item.product.metafields.products["Tax percentage"] %}</span></span>
                </span>
                        {%- else -%}
                            <span class="money">{% include "price-with-rate" | price: item.original_line_price | iva: item.product.metafields.products["Tax percentage"] %}</span>
                        {%- endif -%}
                        {% if item.product.metafields.products["Tax percentage"]== blank   or  shop.taxes_included %}
                            {% assign totalPrice = totalPrice | plus: item.final_line_price %}
                        {% else %}

                            {% assign iva = item.product.metafields.products["Tax percentage"] | replace : "%", "" %}
                            {% assign iva= 100| plus :  iva %}

                            {% assign price_new = item.final_line_price | times: iva | times: 1.0 | divided_by: 100 %}
                            {% assign totalPrice = totalPrice| plus : price_new %}
                        {% endif %}
                        {%- if item.line_level_discount_allocations != blank -%}
                            <ul class="order-discount--cart-list discount--sale-color"
                                aria-label="{{ 'customer.order.discount' | t }}">
                                {% assign discount = 0 %}
                                {%- for discount_allocation in item.line_level_discount_allocations -%}
                                    <li class="order-discount--item">
                                        {% if item.product.metafields.products["Tax percentage"]== blank  or  shop.taxes_included %}
                                            {% assign discount = discount_allocation.amount %}
                                        {% else %}
                                            {% assign iva = item.product.metafields.products["Tax percentage"] | replace : "%", "" %}
                                            {% assign iva= 100| plus :  iva %}
                                            {% assign price_new = discount_allocation.amount | times: iva | times: 1.0 | divided_by: 100 %}
                                            {% assign discount = discount| plus : price_new %}
                                        {% endif %}
                                        <strong>{{ discount_allocation.discount_application.title }} (-<span
                                                    class="money"><span class="price-with-iva">{{ discount | money }}</span><span class="price-without-iva">{{ discount_allocation.amount | money }}</span></span>)</strong>
                                    </li>
                                {%- endfor -%}
                            </ul>
                        {%- endif -%}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        <div class="grid cart__row">
            <div class="grid__item unavailable-products--wrapper hidden">
                <p>{{ section.settings.unavailable-products-title }}</p>
                <ul class="unavailable-products--container">

                </ul>
            </div>
            {% if settings.cart_notes_enable %}
                <div class="grid__item  one-third medium--one-whole small--one-whole">
                    <label for="CartSpecialInstructions">{{ 'cart.general.note' | t }}</label>
                    <textarea name="note" class="input-full" id="CartSpecialInstructions">{{ cart.note }}</textarea>
                </div>
            {% endif %}
            <div class="grid__item  one-third medium--one-whole small--one-whole">
                <div class="identixweb-order-delivery"></div>
            </div>
            <div class="grid__item  cart__footer{% if settings.cart_notes_enable %} one-third medium--one-whole small--one-whole{% endif %}">
                {%- if cart.cart_level_discount_applications != blank -%}
                    <div class="cart--order-discount-wrapper custom-font discount--sale-color">
                        {%- for discount_application in cart.cart_level_discount_applications -%}
                            <div class="cart--order-discount-wrapper--indiv">
              <span class="order-discount--cart-title">

              </span>
                                <span class="order-discount">-<span class="money"></span></span>
                            </div>
                            <p>
                                <span class="cart__subtotal-title"><span
                                            class="hidden">{{ 'customer.order.discount' | t }}
                                        :</span>{{- discount_application.title -}}</span>
                                <span class="h3 cart__subtotal"><span
                                            class="money">{{ discount_application.total_allocated_amount | money }}</span></span>
                            </p>
                        {%- endfor -%}
                    </div>
                {%- endif -%}


                <p>
                    <span class="cart__subtotal-title">{{ 'cart.general.subtotal' | t }}</span>
                    <span class="h3 cart__subtotal"><span class="money"><span class="price-with-iva">{{ totalPrice | money }}</span><span class="price-without-iva">{{ cart.total_price | money }}</span></span></span>
                </p>

                {%- capture taxes_shipping_checkout -%}
                    {%- if shop.taxes_included and shop.shipping_policy.body != blank -%}
                        {{ 'cart.general.taxes_included_and_shipping_policy_html' | t: link: shop.shipping_policy.url }}
                        {%- elsif shop.taxes_included -%}
                        {{ 'cart.general.taxes_included_but_shipping_at_checkout' | t }}
                        {%- elsif shop.shipping_policy.body != blank -%}
                        {{ 'cart.general.taxes_and_shipping_policy_at_checkout_html' | t: link: shop.shipping_policy.url }}
                    {%- else -%}
                        {{ 'cart.general.taxes_and_shipping_at_checkout' | t }}
                    {%- endif -%}
                {%- endcapture -%}

                <div class="cart__shipping rte"><em>{{ taxes_shipping_checkout }}</em></div>

                <input type="submit" name="update" class="btn--secondary update-cart cart--button-update"
                       value="{{ 'cart.general.update' | t }}">
                <input type="submit" name="checkout" class="btn cart--button-checkout "
                       value="{{ 'cart.general.checkout' | t }}">
                {% if additional_checkout_buttons and settings.enable-additional-checkout-buttons %}
                    <div class="additional-checkout-buttons additional-checkout-buttons--vertical">
                        {{ content_for_additional_checkout_buttons }}
                    </div>
                {% endif %}
            </div>
        </div>
    </form>
{% else %}
    <div class="sitewide--title-wrapper">
        {% if settings.heading_style == 'zigzag' %}<span class="zig-zag-border"></span>{% endif %}
        <h1 class="page--title">{{ 'cart.general.title' | t }}</h1>
    </div>
    <div class="cart--empty-cart">
        <p>{{ 'cart.general.empty' | t }}</p>
        <p>{{ 'cart.general.continue_browsing_html' | t }}</p>
    </div>
{% endif %}

<script type="application/json" id="unavailable-products">
    {
        "unavailableCollections": [{% for block in section.blocks %}"{{ block.settings.collection }}"{% unless forloop.last %},{% endunless %} {% endfor %}]
    }
</script>

<script>
    const bannedCollections = JSON.parse(document.querySelector('#unavailable-products').innerHTML);
    const allowedCountries = ["ES", "PT", "AD"];

    if (bannedCollections && bannedCollections.unavailableCollections.length) {
        fetch('https://geoip.crispstudio.cloud/').then(function(response){
            return response.json()
        }).then(function (geoData) {
            if (geoData.status) {
                if (!allowedCountries.includes(geoData.result.code)) {
                    const bannedProducts = [];

                    document.querySelectorAll('[data-item-collections]').forEach(function(bannedItem) {
                        const itemCollections = bannedItem.getAttribute('data-item-collections');
                        const itemTitle = bannedItem.getAttribute('data-item-title');
                        let itemIsBanned = false;
                        itemCollections.split(',').forEach(function(collection) {
                            if (bannedCollections.unavailableCollections.includes(collection)) {
                                itemIsBanned = true;
                            }
                        });

                        if (itemIsBanned) {
                            bannedProducts.push(itemTitle);
                        }
                    });

                    if (bannedProducts.length) {
                        document.querySelector('.unavailable-products--wrapper').classList.remove('hidden');
                        bannedProducts.forEach(function(bannedProductTitle) {
                            let li = document.createElement("li");
                            li.appendChild(document.createTextNode(bannedProductTitle));
                            document.querySelector('.unavailable-products--wrapper ul').appendChild(li)
                        })
                    }
                }
            }
        });
    }
</script>

{% schema %}
{
"name": "Cart template",
"settings": [
{
"type": "richtext",
"id": "unavailable-products-title",
"label": "Unavailable products title"
}
],
"blocks": [
{
"type": "banned-collection",
"name": "Unavailable collection",
"settings": [
{
"type": "collection",
"id": "collection",
"label": "Collection",
"info": "Collection which is not available outside of Spain/Portugal/Andorra"
}
]
}
]
}

{% endschema %}